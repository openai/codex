# CRQ-0XX: Nixification of Codex Submodule

## Objective

The primary objective of this Change Request (CRQ) was to successfully Nixify the `codex` submodule, enabling `nix build` and `nix develop` commands to function correctly. This involved integrating the `codex-cli` and `codex-rs` components into the Nix flake system and standardizing external dependency URLs to `github:meta-introspector`.

## Initial State

The `codex` submodule contained a `flake.nix` file, but the `codex-cli` component, a Node.js application, was not fully integrated into the Nix build system. The `codex-rs` component, a Rust application, had a `default.nix` but required updates for standardized dependency URLs.

## Problems Encountered and Solutions Applied

### 1. Missing `codex-cli/default.nix`

**Problem:** The main `flake.nix` attempted to import `./codex-cli`, expecting a `default.nix` file within the `codex-cli` directory, which was absent.

**Solution:** A `codex-cli/default.nix` file was created. This file defined the Nix package and development shell for the `codex-cli` Node.js application. Initially, it attempted to use `pkgs.buildNpmPackage`, but this proved problematic due to the `pnpm-lock.yaml` location.

### 2. Nix Caching and Git State Issues

**Problem:** After creating `codex-cli/default.nix`, `nix build` and `nix flake check` continued to report "file not found" errors for the newly created file. This was attributed to Nix's caching mechanisms not recognizing the new file or an outdated Git tree state.

**Solution:** The changes (including the new `codex-cli/default.nix`) were committed to the Git repository. Subsequently, `nix flake update` was executed to ensure the `flake.lock` file and Nix's internal state were synchronized with the latest Git tree.

### 3. `pnpm-lock.yaml` and `overrides` Mismatch

**Problem:** The Nix build process for `codex-cli` failed with `ERR_PNPM_LOCKFILE_CONFIG_MISMATCH` or "No cacheable dependencies were found." This was due to the `pnpm-lock.yaml` file (located in the root of the `codex` submodule) containing an `overrides` section that was incompatible with the strict "frozen" installation checks within the Nix build environment. Additionally, the `buildNpmPackage` function struggled with the `pnpm-lock.yaml` being in a different directory than `package.json`.

**Solution:**
*   The `overrides` section was removed from `pnpm-lock.yaml`.
*   The `codex-cli/default.nix` was refactored to use a custom `pkgs.stdenv.mkDerivation` instead of `pkgs.buildNpmPackage`. This custom derivation explicitly copied the root `pnpm-lock.yaml` into the `codex-cli` build directory, ensuring `pnpm install` could find it.
*   The `--frozen-lockfile` flag was removed from the `pnpm install` command within `codex-cli/default.nix`. This allowed `pnpm` to reconcile the lockfile with the `package.json` files without strict frozen checks, resolving the `ERR_PNPM_LOCKFILE_CONFIG_MISMATCH`.
*   The `pnpm-lock.yaml` was regenerated by running `nix-shell -p pnpm --run "pnpm install"` in the root directory and committed.

### 4. Standardization of GitHub URLs

**Problem:** The `flake.nix` and other configuration files used various `github.com` URLs (e.g., `github:NixOS`, `github:numtide`, `github:oxalica`, `github:openai`) that needed to be standardized to `github:meta-introspector` as per project policy.

**Solution:** All instances of the non-standard `github.com` URLs were replaced with their `github:meta-introspector` counterparts in the following files:
*   `flake.nix` (for `nixpkgs`, `flake-utils` (now `nixIntrospector`), and `rust-overlay`)
*   `codex-rs/default.nix` (for `homepage`)
*   `codex-cli/package.json` (for `repository.url`)

## Final State

After implementing the above solutions, both `nix build` and `nix develop` commands now execute successfully for the `codex` submodule. The `codex-cli` and `codex-rs` components are properly integrated into the Nix flake system, and all external GitHub dependencies adhere to the `github:meta-introspector` standardization policy.
