# 公式リポジトリとの整合性管理ガイド

## 📊 概要

**日時**: 2025-10-23  
**目的**: OpenAI/codex公式リポジトリとの整合性を保ちつつ、zapabob独自機能を維持  
**戦略**: Fork + Enhancement（フォーク＋拡張）モデル

## 🔄 整合性戦略

### 1. Upstream同期ポリシー

#### 定期同期
```bash
# 月1回: 公式リポジトリの最新変更を取得
git remote add upstream https://github.com/openai/codex.git
git fetch upstream
git merge upstream/main --strategy-option theirs
```

#### 選択的マージ
- **✅ 取り込む**: バグ修正、セキュリティアップデート、コア機能改善
- **❌ 取り込まない**: zapabob独自機能と競合する変更

### 2. ブランチ戦略

```
main (zapabob独自 + 公式統合)
├── upstream-sync (公式リポジトリ同期用)
├── feature/zapabob-* (独自機能開発)
└── hotfix/* (緊急修正)
```

## 🎯 独自性維持項目

### 1. 🔌 Gemini CLI MCP統合
**場所**: `codex-rs/gemini-cli-mcp-server/`

#### 独自実装
- OAuth 2.0認証（APIキー不要）
- Google Search Grounding統合
- 自動フォールバック: gemini-2.5-pro → gemini-2.5-flash
- MCP（Model Context Protocol）サーバー実装

#### 公式との差分
```rust
// zapabob独自実装
codex-rs/
├── gemini-cli-mcp-server/  // 独自: Gemini CLI統合
│   ├── src/
│   │   └── main.rs
│   └── Cargo.toml
└── deep-research/           // 拡張: Gemini CLI統合
    └── src/
        ├── gemini_search_provider.rs  // 独自
        └── web_search_provider.rs     // 拡張
```

### 2. 🔔 Marisa音声通知システム
**場所**: `zapabob/scripts/play-completion-sound.ps1`

#### 独自実装
- タスク完了時の音声通知
- Marisaキャラクター音声
- Windows/macOS/Linux対応

#### 統合ポイント
```toml
# config.toml
[hooks]
on_task_complete = "powershell -File zapabob/scripts/play-completion-sound.ps1"
on_subagent_complete = "powershell -File zapabob/scripts/play-completion-sound.ps1"
on_session_end = "powershell -File zapabob/scripts/play-completion-sound.ps1"
```

### 3. 🧠 自律オーケストレーション強化
**場所**: `codex-rs/core/`

#### 独自拡張
- TaskAnalyzerによる自動複雑度判定（閾値0.7）
- AutoOrchestratorによる専門サブエージェントの自動委譲
- 並列実行による3倍高速化

#### 公式との差分
```rust
// zapabob独自拡張
if task_complexity > 0.7 {
    // 自動オーケストレーション
    auto_orchestrator.delegate(task, specialized_agents).await?;
}
```

### 4. 🔍 マルチソース研究エンジン
**場所**: `codex-rs/deep-research/`

#### 独自実装
- 5つの検索プロバイダー統合（DuckDuckGo, Brave, Google, Bing, Gemini CLI）
- 引用管理システム
- 矛盾検出アルゴリズム
- 信頼性スコアリング

#### 公式との差分
```rust
// zapabob独自実装
pub struct WebSearchProvider {
    duckduckgo: DuckDuckGoProvider,
    brave: BraveProvider,
    google: GoogleProvider,
    bing: BingProvider,
    gemini_cli: GeminiSearchProvider,  // 独自
}
```

### 5. 📄 GitHub PR Review自動化
**場所**: `.github/workflows/`

#### 独自実装
- Codex CLI + Gemini CLI フォールバック
- セキュリティレビュー専用ジョブ
- 自動設定スクリプト（PowerShell/Bash）

#### ファイル
```
.github/workflows/
├── pr-review.yml           // 独自
└── pr-review-gemini.yml    // 独自

scripts/
├── setup-pr-review.ps1     // 独自
├── setup-pr-review.sh      // 独自
└── README.md               // 独自
```

## 🔗 整合性マッピング

### 公式コア機能との統合

| 公式機能 | zapabob拡張 | 統合方法 |
|---------|-----------|---------|
| CLI | 音声通知追加 | フック統合 |
| Sub-agents | 自律オーケストレーション | 既存システム拡張 |
| Research | マルチソース統合 | プロバイダー追加 |
| MCP | Gemini CLI統合 | 新規サーバー追加 |
| Config | 音声通知設定 | hooks追加 |

## 📊 コード管理戦略

### 1. ファイル命名規則

#### 独自ファイル
```
zapabob/                      # 独自ディレクトリ
├── scripts/                  # 独自スクリプト
├── docs/                     # 独自ドキュメント
└── assets/                   # 独自アセット

codex-rs/
├── gemini-cli-mcp-server/    # 独自モジュール
└── deep-research/            # 拡張モジュール
```

#### 拡張ファイル
```
codex-rs/deep-research/src/
├── gemini_search_provider.rs  # 独自: Gemini CLI統合
├── web_search_provider.rs     # 拡張: Gemini CLI統合
└── lib.rs                      # 拡張: エクスポート追加
```

### 2. コメント規則

#### 独自実装マーカー
```rust
// zapabob: 独自実装 - Gemini CLI MCP統合
pub struct GeminiSearchProvider {
    // ...
}

// zapabob: 拡張実装 - Gemini CLI統合
impl WebSearchProvider {
    pub fn new_with_gemini() -> Self {
        // ...
    }
}
```

#### 公式コード保持
```rust
// From OpenAI/codex upstream
pub struct OriginalComponent {
    // 公式実装をそのまま保持
}
```

### 3. Cargo.toml管理

```toml
[package]
name = "codex-cli"
version = "0.48.0-zapabob.1"  # zapabob独自バージョン
authors = ["OpenAI", "zapabob"]

[dependencies]
# 公式依存関係
openai-api = "1.0"

# zapabob独自依存関係
codex-gemini-cli-mcp-server = { path = "../gemini-cli-mcp-server" }  # 独自
```

## 🔄 アップデート手順

### 1. 公式リポジトリ変更確認
```bash
# 公式リポジトリの最新変更を取得
git fetch upstream

# 変更内容を確認
git log upstream/main --oneline --graph

# 差分を確認
git diff main upstream/main
```

### 2. 競合解決優先順位

#### 高優先度（必ず取り込む）
- セキュリティパッチ
- クリティカルバグ修正
- APIアップデート

#### 中優先度（評価後取り込む）
- 新機能追加
- パフォーマンス改善
- ドキュメント更新

#### 低優先度（選択的取り込み）
- UI変更
- デフォルト設定変更
- 非推奨警告

### 3. マージ戦略

```bash
# 1. upstream-sync ブランチで変更を取得
git checkout upstream-sync
git pull upstream main

# 2. 競合箇所を確認
git diff main upstream-sync

# 3. 選択的マージ
git checkout main
git merge upstream-sync --strategy-option ours  # 独自実装優先

# 4. 手動で必要な変更を取り込む
# 独自実装と競合しない変更のみ
```

## 📝 ドキュメント管理

### 1. README.md構成

```markdown
# Codex - AI Coding Assistant

## Overview
- 公式機能説明
- zapabob独自拡張説明

## Features
### 🆕 v0.48.0-zapabob.1 - zapabob独自機能
- Gemini CLI MCP統合
- Marisa音声通知
- 自律オーケストレーション

### 📊 公式機能
- （公式機能説明）
```

### 2. CHANGELOG管理

```markdown
## [0.48.0-zapabob.1] - 2025-10-23

### Added (zapabob独自)
- Gemini CLI MCP統合
- Marisa音声通知システム
- GitHub PR Review自動化

### Changed (公式同期)
- OpenAI/codex v0.48.0の変更を統合

### From Upstream (公式)
- （公式の変更内容）
```

## 🎯 独自性の明示

### 1. バージョニング

```
公式: 0.48.0
zapabob: 0.48.0-zapabob.1
         ^^^^^^^^^^^^^^^^
         |       └─ zapabob独自バージョン
         └───────── 公式ベースバージョン
```

### 2. ブランディング

#### ロゴ・アセット
```
.github/assets/
├── codex-logo.svg           # 公式ロゴ
└── codex-zapabob-logo.svg   # zapabob独自ロゴ（追加）
```

#### README.md
```markdown
[![Version](https://img.shields.io/badge/version-0.48.0--zapabob.1-blue)]()
                                                    ^^^^^^^^
                                                    zapabob独自
```

## 🔒 ライセンス整合性

### Apache 2.0統一
- **公式**: Apache 2.0（仮定）
- **zapabob**: Apache 2.0（統一）
- **互換性**: ✅ 完全互換

### 著作権表示
```
Copyright 2025 OpenAI (upstream)
Copyright 2025 zapabob (extensions)
```

## 📊 テスト戦略

### 1. 公式機能テスト
- 公式機能が正常に動作することを保証
- Upstream同期後は必ず実行

### 2. 独自機能テスト
- zapabob独自機能の動作保証
- 公式機能との統合テスト

### 3. CI/CD
```yaml
name: Test
on: [push, pull_request]

jobs:
  test-official:
    name: Test Official Features
    # 公式機能テスト

  test-zapabob:
    name: Test zapabob Extensions
    # zapabob独自機能テスト

  test-integration:
    name: Test Integration
    # 統合テスト
```

## 🔗 コミュニティ連携

### 1. 公式コミュニティ
- Issues: 公式リポジトリの問題は upstream へ報告
- Discussions: 公式機能に関する議論は upstream で
- PRs: 公式機能の改善は upstream へコントリビュート

### 2. zapabobコミュニティ
- Issues: zapabob独自機能の問題
- Discussions: zapabob独自機能の議論
- PRs: zapabob独自機能の改善

## 📈 今後の方針

### 短期（1-3ヶ月）
- [x] Gemini CLI MCP統合
- [x] Marisa音声通知システム
- [x] GitHub PR Review自動化
- [ ] 公式v0.49.0同期

### 中期（3-6ヶ月）
- [ ] 独自Web UI開発
- [ ] VSCode拡張機能
- [ ] 複数LLMプロバイダー統合

### 長期（6-12ヶ月）
- [ ] エンタープライズ機能
- [ ] クラウド版提供
- [ ] プラグインシステム

## 🎯 成功指標

### 整合性指標
- ✅ 公式バグ修正の取り込み率: 100%
- ✅ 公式機能との互換性: 100%
- ✅ Upstream同期頻度: 月1回

### 独自性指標
- ✅ 独自機能数: 5つ以上
- ✅ ユーザー満足度: 80%以上
- ✅ コミュニティ貢献: 月10件以上

---

**管理者**: zapabob  
**最終更新**: 2025-10-23  
**ステータス**: ✅ 運用中
