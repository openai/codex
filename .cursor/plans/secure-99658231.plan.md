<!-- 99658231-deb8-46b7-9ce0-c0e3708a1073 518ce962-749e-456f-a1a5-5f94670cad4d -->
# セキュア通信実装計画（Phase 1-3）

## 目的

- 現状ギャップ（平文通信/未署名/未暗号化）を解消し、TLS 1.3 + mTLS + Ed25519署名 + AES-256-GCM + HKDF + Replay防御 + Rate Limitingを段階導入。
- 後方互換性を維持（デフォルト無効・フラグ有効化で切替）。

## 方針

- 機能フラグで段階ロールアウト：`features.mcp_tls_enabled`、`features.agent_security_enabled`、`features.agent_rate_limit_enabled`。
- 失敗時の開発用フォールバック（`allow_insecure_fallback`）。本番は強制有効。

## 変更対象（主要ファイル）

- 依存関係: `codex-rs/core/Cargo.toml`
- 設定型/読み込み: `codex-rs/core/src/config_types.rs`（Phase0済） / `codex-rs/core/src/config_loader.rs`
- MCP TLS: `codex-rs/core/src/mcp/secure_connection.rs`（新規） / `codex-rs/core/src/mcp_connection_manager.rs`（統合）
- エージェント暗号化: `codex-rs/core/src/agents/secure_message.rs`（新規） / `codex-rs/core/src/async_subagent_integration.rs`（統合）
- レート制限: `codex-rs/core/src/agents/rate_limiter.rs`（新規）
- 監査/メトリクス: `codex-rs/core/src/audit_log/`（フック追加） / `codex-rs/core/src/security/dashboard.rs`（新規・後で）
- 設定テンプレ: `config.toml`（secureセクション確定） / `config-secure.toml`（配布）
- 証明書スクリプト: `zapabob/scripts/generate-mcp-certs.ps1|.sh`（既存活用）

## Phase 1（MCP TLS/mTLS・2週間）

- 依存追加: `rustls`, `tokio-rustls`, `rustls-pemfile`, `x509-parser`
- 新規 `secure_connection.rs` 実装：TLS 1.3クライアント、mTLS、CN検証、強暗号スイート固定
- `mcp_connection_manager.rs` 統合：`transport == https`か`features.mcp_tls_enabled`でTLS経路に切替。失敗時フォールバック（devのみ）。
- 設定読込: `config_loader.rs`に`[security]`/`[mcp_servers.*]`のTLS項目をマッピング
- 最小結合テスト：自己署名CAでハンドシェイク、証明書CN不一致で失敗確認

## Phase 2（エージェント署名/暗号・1週間）

- 依存追加: `ed25519-dalek`, `aes-gcm`, `hkdf`, `sha2`
- 新規 `secure_message.rs`：`SecureAgentMessage`（署名・AES-256-GCM・nonce/timestamp）
- `async_subagent_integration.rs`にセキュアチャネルをラップ統合（機能フラグでON）
- キー管理：`~/.codex/keys/agents` から公開鍵信頼リスト読込
- 署名/復号ユニットテスト：改ざん検知、期限超過拒否

## Phase 3（Rate Limiting/監査/統合・1〜2週間）

- 依存追加: `governor`（または自作維持）/ `redis`（オプション）
- 新規 `rate_limiter.rs` 実装し、送信前チェックをフック
- 監査ログ強化：TLS/mTLS/署名失敗/レート超過をJSON Linesに追記
- メトリクス: カウンタ導入（後でGrafana連携）
- 統合テスト：MCP over TLS、署名+暗号ラウンドトリップ、レート制限、回帰

## リリース/移行

- デフォルト無効でリリース → 次リリースで`profiles.production`は有効に
- 証明書配布：スクリプトでCA/サーバ/クライアント発行 → `config-secure.toml`参照
- ドキュメント更新：`README.md`、`_docs/実装ログ` 追記

## ロールバック

- フラグOFFで直戻し。TLS経路はdevのみフォールバック可（本番は不可）。

## テスト（抜粋）

- TLSハンドシェイク成功/失敗、CN不一致、期限切れ
- Ed25519署名改ざん検知、AES-GCM復号失敗
- Replay防御（timestamp > 300sで拒否）
- レート制限（閾値超で429相当）

## 既知リスクと対処

- 証明書運用負荷 → スクリプト/テンプレ提供
- 互換性リスク → 機能フラグ + devフォールバック
- 依存追加によるサイズ増 → releaseビルド/差分リンク最適化

### To-dos

- [ ] core/Cargo.toml に TLS 依存追加
- [ ] secure_connection.rs 実装（TLS 1.3 + mTLS）
- [ ] mcp_connection_manager に TLS 統合とフォールバック
- [ ] config_loader で [security] / TLS 項目読込
- [ ] 署名/暗号 依存追加（dalek/aes-gcm/hkdf/sha2）
- [ ] secure_message.rs 実装（署名+暗号+nonce）
- [ ] async_subagent_integration にセキュアチャネル統合
- [ ] rate_limiter.rs 実装と送信フック
- [ ] 監査ログ/メトリクス フック追加
- [ ] TLS/署名/暗号/RateLimit テスト一式
- [ ] README/実装ログ/設定テンプレ更新