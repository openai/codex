// This Pine ScriptÂ® code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© iranfsrinfo

//@version=6
strategy("Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ ØªØ±Ú©ÛŒØ¨ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ v5", overlay=true, commission_type=strategy.commission.percent, commission_value=0.025, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ======== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ®ØµØµÛŒ ========
fastMA     = ta.ema(close, 3)
medMA      = ta.ema(close, 11)
slowMA     = ta.ema(close, 34)
rsi        = ta.rsi(close, 5)
[_, _, histLine] = ta.macd(close, 4, 15, 3)
atr        = ta.atr(7)
volumeMA   = ta.sma(volume, 9)

// Ù…Ø­Ø§Ø³Ø¨Ù‡ ADX Ø¯Ø³ØªÛŒ
adx(len) =>
    up = ta.change(high)
    down = -ta.change(low)
    trur = ta.rma(ta.tr, len)
    plus = fixnan(100 * ta.rma(up > down and up > 0 ? up : 0, len) / trur)
    minus = fixnan(100 * ta.rma(down > up and down > 0 ? down : 0, len) / trur)
    sum = plus + minus
    adx = 100 * ta.rma(math.abs(plus - minus) / (sum == 0 ? 1 : sum), len)
adxValue = adx(24)

// ======== ÙÛŒÙ„ØªØ±Ù‡Ø§ ========
goldFilter = close > 1500 and timeframe.isdaily and year > 2010

// ======== Ø´Ø±Ø§ÛŒØ· Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ ========
longCondition  = ta.crossover(fastMA, medMA) and close > slowMA + (atr * 0.15) and rsi < 34 and histLine > histLine[3] and volume > volumeMA * 1.28 and adxValue > 36 and goldFilter
shortCondition = ta.crossunder(fastMA, medMA) and close < slowMA - (atr * 0.15) and rsi > 66 and histLine < histLine[3] and volume > volumeMA * 1.28 and adxValue > 36 and goldFilter

// ======== Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú© ========
riskControl = 0.0068 * strategy.equity / (atr * 1.25)

// ======== Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ========
alertMessageLong  = "ğŸš¨ Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯:\nÙ‚ÛŒÙ…Øª: {{close}}\nØ­Ø¬Ù…: {{volume}}\nØ­Ø¯ Ø³ÙˆØ¯: " + str.tostring(close + atr*5.2)
alertMessageShort = "ğŸš¨ Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´:\nÙ‚ÛŒÙ…Øª: {{close}}\nØ­Ø¬Ù…: {{volume}}\nØ­Ø¯ Ø³ÙˆØ¯: " + str.tostring(close - atr*5.2)

// ======== Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒ ========
strategy.entry("Long",  strategy.long,  condition=longCondition,  qty=riskControl, alert_message=alertMessageLong)
strategy.entry("Short", strategy.short, condition=shortCondition, qty=riskControl, alert_message=alertMessageShort)

strategy.exit("Exit Long", "Long", stop=close - atr*0.6, limit=close + atr*5.2, trail_points=atr*3.8, trail_offset=atr*0.55)
strategy.exit("Exit Short", "Short", stop=close + atr*0.6, limit=close - atr*5.2, trail_points=atr*3.8, trail_offset=atr*0.55)

// ======== Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ ========
alertcondition(longCondition,  title='ğŸ“¢ Ù‡Ø´Ø¯Ø§Ø± Ø®Ø±ÛŒØ¯', message='Ø³ÛŒÚ¯Ù†Ø§Ù„ Ø®Ø±ÛŒØ¯ Ø¯Ø± {{ticker}} - Ù‚ÛŒÙ…Øª: {{close}}')
alertcondition(shortCondition, title='ğŸ“¢ Ù‡Ø´Ø¯Ø§Ø± ÙØ±ÙˆØ´', message='Ø³ÛŒÚ¯Ù†Ø§Ù„ ÙØ±ÙˆØ´ Ø¯Ø± {{ticker}} - Ù‚ÛŒÙ…Øª: {{close}}')

// ======== Ù†Ù…Ø§ÛŒØ´Ú¯Ø±Ù‡Ø§ ========
plot(fastMA, "MA Ø³Ø±ÛŒØ¹", #FFD700, 2)
plot(medMA, "MA Ù…ØªÙˆØ³Ø·", #FFA500, 2)
plot(slowMA, "MA Ú©Ù†Ø¯", #FF4500, 2)
plotshape(longCondition, "â–² Ø®Ø±ÛŒØ¯", shape.triangleup, location.belowbar, #00FF00, size=size.large)
plotshape(shortCondition, "â–¼ ÙØ±ÙˆØ´", shape.triangledown, location.abovebar, #FF0000, size=size.large)
