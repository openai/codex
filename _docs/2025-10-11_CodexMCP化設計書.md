# Codex MCP化によるサブエージェント統合設計書

**日付**: 2025-10-11  
**提案者**: User  
**設計者**: AI Assistant (Claude Sonnet 4.5)  
**ステータス**: 🚧 実装中

---

## 🎯 概要

**問題**: Codex内部APIがPrivateのため、サブエージェントから直接呼び出せない

**解決策**: **Codex自体をMCPサーバー化**し、サブエージェントがMCPクライアントとして呼び出す

---

## 🏗️ アーキテクチャ

### Before (現在の実装)
```
┌─────────────────┐
│ Sub-Agent       │
│ (AgentRuntime)  │
│                 │
│ ModelClient ────┼──> LLM API
│ (プロンプトで    │
│  ツール説明)     │
└─────────────────┘
     ❌ Private API制限
     ❌ ツール実行不可
```

### After (MCP化設計)
```
┌─────────────────┐        ┌──────────────────┐
│ Sub-Agent       │  MCP   │ Codex MCP Server │
│ (AgentRuntime)  │ ◄─────►│                  │
│                 │ stdio  │ ✅ read_file      │
│ + MCP Client    │        │ ✅ grep          │
│                 │        │ ✅ codebase_search│
└─────────────────┘        │ ✅ apply_patch   │
     ✅ 標準プロトコル        │ ✅ shell         │
     ✅ 完全なツール実行        └──────────────────┘
     ✅ 権限管理             │
                           │ Codex Core
                           │ (既存の全機能)
                           └─────────────────
```

---

## 📋 実装計画

### ✅ Phase 1: Codex MCP Tools 定義

**ファイル**: `codex-rs/mcp-server/src/codex_tools.rs`

**実装内容**:
```rust
pub struct CodexMcpTool {
    pub name: String,
    pub description: String,
    pub input_schema: Value,
}

// 定義済みツール:
// - codex_read_file       (safe, read-only)
// - codex_grep            (safe, read-only)
// - codex_codebase_search (safe, read-only)
// - codex_apply_patch     (requires write permission)
// - codex_shell           (requires shell permission)
```

**ステータス**: ✅ 完了

---

### 🚧 Phase 2: AgentRuntime に MCP Client 統合

**ファイル**: `codex-rs/core/src/agents/runtime.rs`

**変更内容**:
```rust
use codex_mcp_client::Client as McpClient;

pub struct AgentRuntime {
    // 既存フィールド
    loader: Arc<RwLock<AgentLoader>>,
    budgeter: Arc<TokenBudgeter>,
    
    // 🆕 追加
    mcp_client: Option<Arc<McpClient>>,
    codex_mcp_server_path: PathBuf,
}

impl AgentRuntime {
    async fn execute_agent_with_mcp(
        &self,
        agent_def: &AgentDefinition,
        goal: &str,
    ) -> Result<Vec<String>> {
        // 1. Codex MCP サーバーを起動
        let mcp_client = self.spawn_codex_mcp_server().await?;
        
        // 2. エージェント権限に基づいてツールをフィルタリング
        let allowed_tools = self.filter_tools_by_permissions(
            &agent_def.tools.mcp
        );
        
        // 3. ModelClient + MCP Tools でLLM呼び出し
        let prompt = self.build_prompt_with_mcp_tools(
            agent_def,
            goal,
            &allowed_tools
        );
        
        // 4. ツール呼び出し時にMCPクライアント経由で実行
        // ...
    }
    
    async fn spawn_codex_mcp_server(&self) -> Result<Arc<McpClient>> {
        // codex mcp-server を stdio モードで起動
        let mut child = Command::new(&self.codex_mcp_server_path)
            .arg("mcp-server")
            .stdin(Stdio::piped())
            .stdout(Stdio::piped())
            .spawn()?;
        
        let client = McpClient::new(
            child.stdin.take().unwrap(),
            child.stdout.take().unwrap()
        );
        
        Ok(Arc::new(client))
    }
}
```

**ステータス**: ⏳ 次のステップ

---

### 🔜 Phase 3: エージェント定義の更新

**ファイル**: `.codex/agents/code-reviewer.yaml`

**Before**:
```yaml
tools:
  mcp:
    - grep        # 汎用MCPツール
    - read_file   # 汎用MCPツール
```

**After**:
```yaml
tools:
  mcp:
    # Codex専用MCPツール（完全なCodex機能）
    - codex_read_file       # ✅ Codex経由でファイル読み取り
    - codex_grep            # ✅ Codex経由でgrep
    - codex_codebase_search # ✅ セマンティック検索
    # codex_shell は許可しない（セキュリティ）
```

---

### 🔜 Phase 4: 権限チェック統合

**ファイル**: `codex-rs/core/src/agents/permission_checker.rs`

**追加機能**:
```rust
impl PermissionChecker {
    pub fn check_codex_mcp_tool(&self, tool_name: &str) -> Result<()> {
        // エージェント定義の tools.mcp に含まれているか確認
        if self.permissions.mcp.contains(&tool_name.to_string()) {
            Ok(())
        } else {
            Err(anyhow!(
                "Codex MCP tool '{}' is not permitted for this agent",
                tool_name
            ))
        }
    }
}
```

---

## 🎁 利点

### 1. **Private API問題の完全解決**
```
❌ 旧: crate::codex::Codex (Private)
✅ 新: MCP Protocol (Standard)
```

### 2. **既存実装の再利用**
- `codex mcp-server` コマンド（既存）
- `codex-mcp-client` クレート（既存）
- Codex Core の全機能（既存）

### 3. **明確な権限管理**
```yaml
# セキュリティレベル別のツール分類
safe_tools:          # 読み取りのみ
  - codex_read_file
  - codex_grep
  - codex_codebase_search

moderate_tools:      # 書き込み可能
  - codex_apply_patch

dangerous_tools:     # シェル実行
  - codex_shell      # 通常は許可しない
```

### 4. **サンドボックス化の向上**
```
┌─────────────────────┐
│ Sub-Agent Process   │ ← 制限された環境
│ (MCP Client)        │
└──────────┬──────────┘
           │ MCP over stdio
           │ (プロセス間通信)
┌──────────▼──────────┐
│ Codex MCP Server    │ ← 完全な権限
│ (Parent Process)    │
└─────────────────────┘
```

### 5. **テストの容易性**
```rust
#[tokio::test]
async fn test_agent_with_mock_mcp() {
    // MockMcpServer でテスト可能
    let mock_server = MockCodexMcpServer::new();
    let runtime = AgentRuntime::new_with_mcp(mock_server);
    // ...
}
```

---

## 🔒 セキュリティ考慮事項

### 1. **ツール権限の階層化**

```yaml
# Level 1: Safe (デフォルト許可)
codex_read_file
codex_grep
codex_codebase_search

# Level 2: Moderate (明示的許可必要)
codex_apply_patch
codex_write_file

# Level 3: Dangerous (厳格な審査必要)
codex_shell
codex_delete_file
```

### 2. **実行時チェック**

```rust
// AgentRuntime で二重チェック
fn check_tool_call(&self, tool_name: &str) -> Result<()> {
    // 1. エージェント定義チェック
    self.permission_checker.check_mcp_tool(tool_name)?;
    
    // 2. 実行時ポリシーチェック
    self.runtime_policy.check_tool(tool_name)?;
    
    // 3. トークン予算チェック
    self.budgeter.check_remaining()?;
    
    Ok(())
}
```

### 3. **監査ログ**

```rust
// 全MCPツール呼び出しをログ
log_audit_event(AuditEvent::new(
    agent_name,
    AuditEventType::McpToolCall {
        tool: "codex_shell".to_string(),
        args: serde_json::json!({"command": "ls"}),
        result: "success",
    }
));
```

---

## 📊 実装ステップ

### 🎯 短期 (1-2日)
- [x] Phase 1: Codex MCP Tools 定義
- [ ] Phase 2: AgentRuntime MCP統合
- [ ] Phase 3: エージェント定義更新
- [ ] Phase 4: 基本テスト

### 🚀 中期 (1週間)
- [ ] 完全な権限チェック実装
- [ ] 監査ログ統合
- [ ] エラーハンドリング強化
- [ ] ドキュメント更新

### ⭐ 長期 (1ヶ月)
- [ ] パフォーマンス最適化
- [ ] 並列実行サポート
- [ ] カスタムMCPツール定義
- [ ] インタラクティブモード統合

---

## 🧪 テスト計画

### Unit Tests
```rust
#[tokio::test]
async fn test_codex_mcp_tool_definition() {
    let tools = CodexMcpTool::safe_tools();
    assert_eq!(tools.len(), 3);
}

#[tokio::test]
async fn test_agent_runtime_mcp_spawn() {
    let runtime = AgentRuntime::new(...);
    let client = runtime.spawn_codex_mcp_server().await.unwrap();
    // MCPサーバーが起動することを確認
}
```

### Integration Tests
```bash
# エージェント実行テスト（MCP経由）
codex delegate code-reviewer \
  --goal "Review code with Codex MCP tools" \
  --scope ./src

# 期待される動作:
# 1. Codex MCPサーバーが自動起動
# 2. code-reviewer が codex_read_file を呼び出し
# 3. code-reviewer が codex_grep を呼び出し
# 4. code-reviewer が codex_codebase_search を呼び出し
# 5. レビューレポート生成
```

---

## 📝 ドキュメント更新

### SUBAGENTS_QUICKSTART.md
```markdown
## Codex MCP Integration

Sub-agents can use Codex's full capabilities via MCP:

\`\`\`yaml
# .codex/agents/my-agent.yaml
tools:
  mcp:
    - codex_read_file
    - codex_grep
    - codex_codebase_search
\`\`\`

These tools provide:
- ✅ Full Codex functionality
- ✅ Proper sandboxing
- ✅ Permission management
- ✅ Audit logging
```

---

## 🎉 期待される効果

### Before (現状)
```
❌ Private API制限
❌ プロンプトでツール説明のみ
❌ 実際のツール実行不可
⚠️  TODO コメントだらけ
```

### After (MCP化後)
```
✅ 標準MCPプロトコル
✅ 完全なツール実行
✅ 権限ベースの制御
✅ 監査ログ完備
✨ Production Ready
```

---

## 🔗 関連ファイル

### 新規作成
- `codex-rs/mcp-server/src/codex_tools.rs`
- `_docs/2025-10-11_CodexMCP化設計書.md`

### 変更予定
- `codex-rs/core/src/agents/runtime.rs`
- `codex-rs/mcp-server/src/lib.rs`
- `.codex/agents/*.yaml`
- `SUBAGENTS_QUICKSTART.md`

---

## 💡 今後の拡張

### 1. カスタムCodexツール
```yaml
tools:
  mcp:
    - codex_custom:my_analyzer  # カスタムツール定義
```

### 2. ツールチェーン
```yaml
tools:
  mcp:
    - codex_grep → codex_read_file → codex_apply_patch
  # 自動的にツールを連鎖実行
```

### 3. 並列実行
```yaml
delegation:
  parallel: true  # 複数エージェント並列実行
  tools:
    - codex_*  # 同時にCodexツール呼び出し
```

---

**Project**: zapabob/codex  
**Version**: 0.47.0-alpha.1 → 0.47.0-alpha.2 (予定)  
**Status**: 🚧 実装中  
**Completion Target**: 2025-10-12


