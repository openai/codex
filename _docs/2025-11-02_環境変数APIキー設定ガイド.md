# 🔒 Codex APIキー環境変数設定ガイド

**作成日**: 2025-11-02  
**バージョン**: v0.56.0-zapabob  
**ステータス**: ✅ 実装済み・本番環境推奨

---

## 📋 概要

Codexは既に環境変数からAPIキーを読み込む機能が実装されています。
**config.tomlへのAPIキーのハードコードは不要**です。

### 🎯 セキュリティベストプラクティス

✅ **推奨**: 環境変数でAPIキーを管理  
❌ **非推奨**: config.tomlやauth.jsonにAPIキーをハードコード

---

## 🔍 実装状況確認

### 既存実装の確認結果

#### 1. 環境変数サポート（auth.rs 209-224行）

```rust
pub const OPENAI_API_KEY_ENV_VAR: &str = "OPENAI_API_KEY";
pub const CODEX_API_KEY_ENV_VAR: &str = "CODEX_API_KEY";

pub fn read_openai_api_key_from_env() -> Option<String> {
    env::var(OPENAI_API_KEY_ENV_VAR)
        .ok()
        .map(|value| value.trim().to_string())
        .filter(|value| !value.is_empty())
}

pub fn read_codex_api_key_from_env() -> Option<String> {
    env::var(CODEX_API_KEY_ENV_VAR)
        .ok()
        .map(|value| value.trim().to_string())
        .filter(|value| !value.is_empty())
}
```

#### 2. 優先順位（auth.rs 356-399行）

```rust
fn load_auth(
    codex_home: &Path,
    enable_codex_api_key_env: bool,
    auth_credentials_store_mode: AuthCredentialsStoreMode,
) -> std::io::Result<Option<CodexAuth>> {
    // 🥇 1st Priority: CODEX_API_KEY environment variable
    if enable_codex_api_key_env && let Some(api_key) = read_codex_api_key_from_env() {
        let client = crate::default_client::create_client();
        return Ok(Some(CodexAuth::from_api_key_with_client(
            api_key.as_str(),
            client,
        )));
    }

    // 🥈 2nd Priority: auth.json file
    let storage = create_auth_storage(codex_home.to_path_buf(), auth_credentials_store_mode);
    let auth_dot_json = match storage.load()? {
        Some(auth) => auth,
        None => return Ok(None),
    };

    // 🥉 3rd Priority: OAuth tokens
    if let Some(api_key) = &auth_json_api_key {
        return Ok(Some(CodexAuth::from_api_key_with_client(api_key, client)));
    }

    // Fallback to ChatGPT OAuth mode
    Ok(Some(CodexAuth { ... }))
}
```

#### 3. config.toml設定（17行目）

```toml
[model_providers.openai]
base_url = "https://api.openai.com/v1"
env_key = "OPENAI_API_KEY"  # ← 環境変数名を指定
name = "OpenAI (Chat Completions API)"
requires_openai_auth = true
wire_api = "chat"
```

---

## ⚙️ 環境変数設定方法

### Windows PowerShell（推奨）

#### 1. 一時的に設定（現在のセッションのみ）

```powershell
# OpenAI APIキー設定
$env:OPENAI_API_KEY = "sk-proj-XXXXXXXXXXXXXXXXXXXX"

# Codex APIキー設定（優先度が最も高い）
$env:CODEX_API_KEY = "sk-proj-XXXXXXXXXXXXXXXXXXXX"

# GitHub Token設定（GitHub MCP Server用）
$env:GITHUB_TOKEN = "ghp_XXXXXXXXXXXXXXXXXXXX"

# Gemini APIキー設定（Gemini MCP Server用）
$env:GEMINI_API_KEY = "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX"

# 設定確認
echo $env:OPENAI_API_KEY
echo $env:CODEX_API_KEY
```

#### 2. 永続的に設定（システム環境変数）

```powershell
# システム環境変数として永続化（管理者権限必要）
[System.Environment]::SetEnvironmentVariable("OPENAI_API_KEY", "sk-proj-XXXX", [System.EnvironmentVariableTarget]::User)
[System.Environment]::SetEnvironmentVariable("CODEX_API_KEY", "sk-proj-XXXX", [System.EnvironmentVariableTarget]::User)
[System.Environment]::SetEnvironmentVariable("GITHUB_TOKEN", "ghp_XXXX", [System.EnvironmentVariableTarget]::User)
[System.Environment]::SetEnvironmentVariable("GEMINI_API_KEY", "AIzaSyXXXX", [System.EnvironmentVariableTarget]::User)

# 確認
[System.Environment]::GetEnvironmentVariable("OPENAI_API_KEY", [System.EnvironmentVariableTarget]::User)
```

#### 3. PowerShell Profile設定（自動読み込み）

```powershell
# PowerShell Profileを開く
notepad $PROFILE

# 以下を追加（APIキーは別ファイルに分離推奨）
$env:OPENAI_API_KEY = "sk-proj-XXXXXXXXXXXXXXXXXXXX"
$env:CODEX_API_KEY = "sk-proj-XXXXXXXXXXXXXXXXXXXX"
$env:GITHUB_TOKEN = "ghp_XXXXXXXXXXXXXXXXXXXX"
$env:GEMINI_API_KEY = "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX"

# Profile再読み込み
. $PROFILE
```

### Linux/macOS（bash/zsh）

#### 1. 一時的に設定（現在のセッションのみ）

```bash
# OpenAI APIキー設定
export OPENAI_API_KEY="sk-proj-XXXXXXXXXXXXXXXXXXXX"

# Codex APIキー設定（優先度が最も高い）
export CODEX_API_KEY="sk-proj-XXXXXXXXXXXXXXXXXXXX"

# GitHub Token設定
export GITHUB_TOKEN="ghp_XXXXXXXXXXXXXXXXXXXX"

# Gemini APIキー設定
export GEMINI_API_KEY="AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX"

# 設定確認
echo $OPENAI_API_KEY
echo $CODEX_API_KEY
```

#### 2. 永続的に設定（.bashrc / .zshrc）

```bash
# ~/.bashrc または ~/.zshrc を編集
nano ~/.bashrc  # または nano ~/.zshrc

# 以下を追加
export OPENAI_API_KEY="sk-proj-XXXXXXXXXXXXXXXXXXXX"
export CODEX_API_KEY="sk-proj-XXXXXXXXXXXXXXXXXXXX"
export GITHUB_TOKEN="ghp_XXXXXXXXXXXXXXXXXXXX"
export GEMINI_API_KEY="AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX"

# 設定を即座に反映
source ~/.bashrc  # または source ~/.zshrc
```

#### 3. セキュアな設定方法（.env ファイル使用）

```bash
# ~/.codex/.env ファイルを作成
mkdir -p ~/.codex
nano ~/.codex/.env

# .envファイルに記述
OPENAI_API_KEY=sk-proj-XXXXXXXXXXXXXXXXXXXX
CODEX_API_KEY=sk-proj-XXXXXXXXXXXXXXXXXXXX
GITHUB_TOKEN=ghp_XXXXXXXXXXXXXXXXXXXX
GEMINI_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX

# パーミッション設定（自分だけ読み書き可能）
chmod 600 ~/.codex/.env

# .bashrc / .zshrcから読み込み
echo 'set -a; source ~/.codex/.env; set +a' >> ~/.bashrc
source ~/.bashrc
```

---

## 🔄 設定の優先順位

Codexは以下の優先順位でAPIキーを読み込みます：

### 優先度1: `CODEX_API_KEY` 環境変数 🥇

```bash
export CODEX_API_KEY="sk-proj-XXXX"
```

- **最優先**: この環境変数が設定されていれば、他の設定より優先
- **推奨用途**: Codex専用のAPIキーを使用する場合

### 優先度2: `auth.json` ファイル 🥈

```bash
~/.codex/auth.json
```

- **自動生成**: `codex login` コマンドで自動作成
- **OAuth対応**: ChatGPT OAuth認証にも対応

### 優先度3: `OPENAI_API_KEY` 環境変数 🥉

```bash
export OPENAI_API_KEY="sk-proj-XXXX"
```

- **汎用**: OpenAI APIを使用する他のツールと共通
- **フォールバック**: `CODEX_API_KEY`が未設定の場合に使用

---

## ✅ 設定確認方法

### 1. 環境変数の確認

**Windows PowerShell:**
```powershell
# 現在の環境変数を確認
Get-ChildItem Env: | Where-Object { $_.Name -like "*API_KEY*" -or $_.Name -like "*TOKEN*" }

# 特定の環境変数を確認
echo $env:CODEX_API_KEY
echo $env:OPENAI_API_KEY
echo $env:GITHUB_TOKEN
echo $env:GEMINI_API_KEY
```

**Linux/macOS:**
```bash
# 現在の環境変数を確認
env | grep -E "(API_KEY|TOKEN)"

# 特定の環境変数を確認
echo $CODEX_API_KEY
echo $OPENAI_API_KEY
echo $GITHUB_TOKEN
echo $GEMINI_API_KEY
```

### 2. Codexの認証状態確認

```bash
# Codexがどの認証方法を使用しているか確認
codex --help

# 実際にAPIを呼び出して確認
codex exec "echo test"
```

### 3. auth.jsonの確認

```bash
# auth.jsonの内容を確認（APIキーが含まれる場合があるので注意）
cat ~/.codex/auth.json

# auth.jsonを削除（環境変数のみで認証する場合）
rm ~/.codex/auth.json
```

---

## 🛡️ セキュリティベストプラクティス

### ❌ やってはいけないこと

1. **config.tomlにAPIキーをハードコード**
   ```toml
   # ❌ BAD: ハードコード（Gitにコミットされるリスク）
   [model_providers.openai]
   api_key = "sk-proj-XXXXXXXXXXXXXXXXXXXX"
   ```

2. **公開リポジトリにAPIキーをコミット**
   ```bash
   # ❌ BAD: .envファイルをGitに追加
   git add .env
   git commit -m "Add API keys"  # 絶対にやらない！
   ```

3. **APIキーを平文でコード内に記述**
   ```python
   # ❌ BAD: ハードコード
   OPENAI_API_KEY = "sk-proj-XXXXXXXXXXXXXXXXXXXX"
   ```

### ✅ やるべきこと

1. **環境変数で管理**
   ```bash
   # ✅ GOOD: 環境変数
   export CODEX_API_KEY="sk-proj-XXXXXXXXXXXXXXXXXXXX"
   ```

2. **.gitignoreに追加**
   ```gitignore
   # ✅ GOOD: .gitignoreに追加
   .env
   .env.local
   auth.json
   *.key
   *.pem
   ```

3. **パーミッション制限**
   ```bash
   # ✅ GOOD: 自分だけ読み書き可能
   chmod 600 ~/.codex/.env
   chmod 600 ~/.codex/auth.json
   ```

4. **定期的なローテーション**
   - APIキーは定期的に再生成
   - 使用していないAPIキーは削除
   - 流出が疑われる場合は即座に無効化

---

## 🔧 トラブルシューティング

### 問題1: 環境変数が反映されない

**原因**: PowerShellセッションを再起動していない

**解決策**:
```powershell
# PowerShellを再起動するか、Profileを再読み込み
. $PROFILE
```

### 問題2: `CODEX_API_KEY`と`OPENAI_API_KEY`の両方が設定されている

**動作**: `CODEX_API_KEY`が優先されます

**確認方法**:
```powershell
echo $env:CODEX_API_KEY
echo $env:OPENAI_API_KEY
```

### 問題3: Codexが環境変数を読み込まない

**原因1**: `enable_codex_api_key_env`が無効化されている

**解決策**: config.tomlを確認
```toml
# この設定がない場合、デフォルトでtrueなので問題なし
# enable_codex_api_key_env = true
```

**原因2**: auth.jsonが優先されている

**解決策**: auth.jsonを削除
```bash
rm ~/.codex/auth.json
```

### 問題4: MCP Serverが環境変数を読み込まない

**原因**: config.tomlでMCPサーバーに環境変数が渡されていない

**解決策**: config.tomlを確認（既に設定済み）
```toml
[mcp_servers.codex]
env.OPENAI_API_KEY = "${OPENAI_API_KEY}"  # ← 環境変数を受け渡し
env.GITHUB_TOKEN = "${GITHUB_TOKEN}"
```

---

## 📦 MCP Server環境変数設定

### 現在の設定状況（config.toml）

Codexの各MCPサーバーは以下の環境変数を使用します：

```toml
# Codex MCP Server
[mcp_servers.codex]
env.GITHUB_TOKEN = "${GITHUB_TOKEN}"
env.OPENAI_API_KEY = "${OPENAI_API_KEY}"
env.RUST_LOG = "info"
env.SLACK_WEBHOOK_URL = "${SLACK_WEBHOOK_URL}"

# Codex Research
[mcp_servers.codex-research]
env.OPENAI_API_KEY = "${OPENAI_API_KEY}"
env.RUST_LOG = "info"

# Codex Agent
[mcp_servers.codex-agent]
env.OPENAI_API_KEY = "${OPENAI_API_KEY}"
env.RUST_LOG = "info"

# GitHub MCP Server
[mcp_servers.github]
env.GITHUB_TOKEN = "${GITHUB_TOKEN}"

# Gemini MCP Server
[mcp_servers.codex-gemini-mcp]
# GeminiはCLIが自動的に環境変数を読み込む
# GEMINI_API_KEY または GOOGLE_AI_STUDIO_API_KEY

# Brave Search MCP Server
[mcp_servers.brave-search]
env.BRAVE_API_KEY = "${BRAVE_API_KEY}"
disabled = true  # APIキー設定後に有効化
```

### 必要な環境変数一覧

| 環境変数名 | 用途 | 必須/任意 | 使用するMCPサーバー |
|-----------|------|----------|-------------------|
| `CODEX_API_KEY` | Codex専用OpenAI APIキー | 推奨 | すべて |
| `OPENAI_API_KEY` | OpenAI APIキー | 必須 | codex, codex-research, codex-agent |
| `GITHUB_TOKEN` | GitHub Personal Access Token | 任意 | github, codex |
| `GEMINI_API_KEY` | Google Gemini APIキー | 任意 | codex-gemini-mcp |
| `GOOGLE_AI_STUDIO_API_KEY` | Google AI Studio APIキー | 任意 | codex-gemini-mcp（代替） |
| `BRAVE_API_KEY` | Brave Search APIキー | 任意 | brave-search |
| `SLACK_WEBHOOK_URL` | Slack Webhook URL | 任意 | codex（通知用） |

---

## 🎯 推奨設定パターン

### パターン1: 最小構成（OpenAI APIのみ）

```powershell
# Windows PowerShell
$env:CODEX_API_KEY = "sk-proj-XXXXXXXXXXXXXXXXXXXX"

# 確認
codex exec "echo test"
```

```bash
# Linux/macOS
export CODEX_API_KEY="sk-proj-XXXXXXXXXXXXXXXXXXXX"

# 確認
codex exec "echo test"
```

### パターン2: フル機能構成（すべてのMCPサーバー）

```powershell
# Windows PowerShell
$env:CODEX_API_KEY = "sk-proj-XXXXXXXXXXXXXXXXXXXX"
$env:OPENAI_API_KEY = "sk-proj-XXXXXXXXXXXXXXXXXXXX"
$env:GITHUB_TOKEN = "ghp_XXXXXXXXXXXXXXXXXXXX"
$env:GEMINI_API_KEY = "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX"
$env:BRAVE_API_KEY = "BSA_XXXXXXXXXXXXXXXXXXXX"
$env:SLACK_WEBHOOK_URL = "https://hooks.slack.com/services/XXX/XXX/XXX"

# Brave Search MCPサーバーを有効化
# config.tomlの[mcp_servers.brave-search]セクションから`disabled = true`を削除

# 確認
codex exec "test all features"
```

```bash
# Linux/macOS
export CODEX_API_KEY="sk-proj-XXXXXXXXXXXXXXXXXXXX"
export OPENAI_API_KEY="sk-proj-XXXXXXXXXXXXXXXXXXXX"
export GITHUB_TOKEN="ghp_XXXXXXXXXXXXXXXXXXXX"
export GEMINI_API_KEY="AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX"
export BRAVE_API_KEY="BSA_XXXXXXXXXXXXXXXXXXXX"
export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/XXX/XXX/XXX"

# 確認
codex exec "test all features"
```

### パターン3: セキュア構成（.envファイル使用）

```bash
# 1. .envファイル作成
mkdir -p ~/.codex
nano ~/.codex/.env

# 2. 以下を記述
CODEX_API_KEY=sk-proj-XXXXXXXXXXXXXXXXXXXX
OPENAI_API_KEY=sk-proj-XXXXXXXXXXXXXXXXXXXX
GITHUB_TOKEN=ghp_XXXXXXXXXXXXXXXXXXXX
GEMINI_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX
BRAVE_API_KEY=BSA_XXXXXXXXXXXXXXXXXXXX
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/XXX/XXX/XXX

# 3. パーミッション設定
chmod 600 ~/.codex/.env

# 4. .bashrc / .zshrcから読み込み
echo 'set -a; source ~/.codex/.env; set +a' >> ~/.bashrc
source ~/.bashrc

# 5. 確認
env | grep -E "(CODEX|OPENAI|GITHUB|GEMINI|BRAVE|SLACK)"
```

---

## 📚 関連ドキュメント

- [OpenAI API Keys](https://platform.openai.com/api-keys)
- [GitHub Personal Access Tokens](https://github.com/settings/tokens)
- [Google AI Studio API Keys](https://aistudio.google.com/app/apikey)
- [Brave Search API](https://brave.com/search/api/)
- [.cursorrules - Security Best Practices](../.cursorrules)

---

## 📝 まとめ

### ✅ 実装済み機能

- 環境変数からのAPIキー読み込み（`CODEX_API_KEY`, `OPENAI_API_KEY`）
- 優先順位制御（環境変数 > auth.json > OAuth）
- MCP Serverへの環境変数受け渡し
- セキュアな認証機構

### 🎯 推奨設定

1. **環境変数で管理** - config.tomlにハードコード不要
2. **CODEX_API_KEYを使用** - 最優先で読み込まれる
3. **.gitignoreに追加** - APIキーの流出防止
4. **定期的なローテーション** - セキュリティ強化

### 🚀 次のステップ

1. 環境変数を設定
2. config.tomlからハードコードされたAPIキーを削除（存在する場合）
3. auth.jsonを削除（環境変数のみで認証する場合）
4. Codexを起動して動作確認

---

**作成者**: Cursor Agent  
**レビュー**: zapabob  
**ステータス**: ✅ Production Ready  
**最終更新**: 2025-11-02


