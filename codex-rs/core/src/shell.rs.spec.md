## Overview
`core::shell` detects the user’s default shell and normalizes shell invocations for tool execution. It ensures commands run with the expected startup scripts (e.g., `.zshrc`, `.bashrc`), handles PowerShell specifics on Windows, and provides fallbacks when models generate bash-style commands on non-bash shells.

## Detailed Behavior
- Defines structs for shell configurations (`ZshShell`, `BashShell`, `PowerShellConfig`) and the `Shell` enum (`Zsh`, `Bash`, `PowerShell`, `Unknown`).
- `format_default_shell_invocation`:
  - For Zsh/Bash, builds a `shell_path -lc "<command>"` invocation, sourcing the relevant rc file when it exists (so custom aliases/functions are available).
  - For PowerShell:
    - Detects `bash -lc` commands and, if a bash fallback executable is configured, reroutes them to bash. Otherwise, wraps the script in a PowerShell command.
    - For non-bash commands, ensures the command runs via `powershell.exe`/`pwsh` when the model hasn’t already prefixed it.
  - For `Unknown`, returns `None`, signalling callers to avoid shell wrapping.
- `name` returns a user-friendly shell name (e.g., `bash`, `pwsh`) when available.
- `default_user_shell`:
  - On Unix, uses `getpwuid` to inspect the user’s login shell, returning `Zsh`, `Bash`, or `Unknown`.
  - On Windows, probes for PowerShell 7 (`pwsh`) and optionally a bash fallback before defaulting to Windows PowerShell.
- Helpers like `strip_bash_lc` detect `<bash> -lc <cmd>` sequences, allowing the code to strip the wrapper or rewrap appropriately.
- Tests cover rc-file sourcing, newline handling, PowerShell conversions, and cross-platform shell detection.

## Broader Context
- `codex.rs` uses `default_user_shell` during session initialization to populate environment context and to format execution commands in `handle_container_exec_with_params`.
- Ensuring rc files are sourced provides user-defined functions/aliases, reducing friction when models rely on those.
- PowerShell handling is critical on Windows, where the shell must translate or reject bash-specific commands generated by models.

## Technical Debt
- TODO references (e.g., improved newline escaping for PowerShell) hint at potential enhancements for command quoting.

---
tech_debt:
  severity: medium
  highest_priority_items:
    - Improve PowerShell command escaping (especially multiline scripts) to avoid execution errors noted in TODO `CODEX_2900`.
related_specs:
  - ./exec.rs.spec.md
  - ./exec_env.rs.spec.md
  - ./tools/handlers/shell.rs.spec.md
