## Overview
`client.rs` implements the HTTP client for Codex and ChatGPT backend APIs. It normalizes base URLs, constructs auth headers, and exposes helpers for rate limits, task management, and sibling turn queries, returning strongly typed results built on top of `reqwest`.

## Detailed Behavior
- `PathStyle` decides which URL prefix to target (`/api/codex` vs. `/wham`) based on the base URL. `from_base_url` detects ChatGPT hosts containing `/backend-api`.
- `Client` state:
  - Stores normalized `base_url`, a shared `reqwest::Client`, optional bearer token, user agent, ChatGPT account id, and `PathStyle`.
  - `new` trims trailing slashes and rewrites common ChatGPT hosts (`chatgpt.com`, `chat.openai.com`) to append `/backend-api`.
  - `from_auth` pulls a token from `CodexAuth`, injects the standard Codex user agent, and copies the account id when available.
  - Builder-style setters (`with_bearer_token`, `with_user_agent`, `with_chatgpt_account_id`, `with_path_style`) customize headers fluently.
- Request helpers:
  - `headers` assembles default `USER_AGENT`, `Authorization: Bearer`, and optional `ChatGPT-Account-Id`.
  - `exec_request` sends a request, collects the entire response body, and bails with a descriptive error when status is non-success.
  - `decode_json` wraps `serde_json::from_str`, embedding the URL, content type, and body in error messages for debugging.
- Backend methods:
  - `get_rate_limits` hits `/api/codex/usage` or `/wham/usage`, decodes `RateLimitStatusPayload`, and converts it to `RateLimitSnapshot` (mapping primary/secondary windows, coalescing double-option payloads).
  - `list_tasks` queries `/tasks/list`, threading optional `limit`, `task_filter`, and `environment_id` query parameters.
  - `get_task_details`/`get_task_details_with_body` fetch task metadata and optionally return raw JSON.
  - `list_sibling_turns` fetches sibling turns for a given task/turn id.
  - `create_task` posts a JSON request to create a task, returning the created task id from either `task.id` or top-level `id`.
- Private helpers convert rate-limit windows from seconds to minutes and unwrap nested `Option<Option<Box<_>>>` structures generated by OpenAPI.

## Broader Context
- Used by app-server and other services needing direct REST access to Codex backend functionality. Complements `codex_core::auth` for credential management.
- Rate limit data informs UI notifications and logging across Codex clients.

## Technical Debt
- Base URL detection is string-based; if backend endpoints change format, the normalization logic may need to be revisited.

---
tech_debt:
  severity: low
  highest_priority_items:
    - Harden ChatGPT base URL detection if additional hosts or prefixes are introduced.
related_specs:
  - ../mod.spec.md
  - ./lib.rs.spec.md
  - ./types.rs.spec.md
