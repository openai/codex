name: winget-fork-test

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to publish to WinGet
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Validate release tag
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          release_tag="${{ inputs.release_tag }}"
          if [[ ! "${release_tag}" =~ ^rust-v[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta)(\.[0-9]+)?)?$ ]]; then
            echo "Invalid release tag: ${release_tag}"
            exit 1
          fi

          version="${release_tag#rust-v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Publish to WinGet via winget-releaser
        uses: vedantmgoyal9/winget-releaser@19e706d4c9121098010096f9c495a70a7518b30f
        with:
          identifier: OpenAI.Codex
          version: ${{ steps.vars.outputs.version }}
          release-tag: ${{ inputs.release_tag }}
          fork-user: openai-oss-forks
          installers-regex: '^codex-(?:x86_64|aarch64)-pc-windows-msvc\.exe\.zip$'
          token: ${{ secrets.WINGET_PUBLISH_PAT }}

      - name: Summarize result
        shell: bash
        run: |
          {
            echo "WinGet publish test completed."
            echo "- Fork owner: openai-oss-forks"
            echo "- Release tag: ${{ inputs.release_tag }}"
            echo "- Package version: ${{ steps.vars.outputs.version }}"
            echo "- This workflow may have created a real upstream PR."
          } >> "$GITHUB_STEP_SUMMARY"
