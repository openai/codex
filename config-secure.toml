# Codex Secure Configuration (TLS/mTLS + Encrypted Agents)
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v0.51.0-zapabob.1 (Secure Edition)
# ä½œæˆæ—¥: 2025-10-28
# è¨­è¨ˆæ›¸: _docs/2025-10-28_ã‚»ã‚­ãƒ¥ã‚¢é€šä¿¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸.md
#
# ğŸ“‹ ä½¿ç”¨æ–¹æ³•:
#   1. zapabob/scripts/generate-mcp-certs.ps1 ã‚’å®Ÿè¡Œã—ã¦è¨¼æ˜æ›¸ç”Ÿæˆ
#   2. config.toml ã‚’ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ç½®ãæ›ãˆã‚‹ã‹ã€è¨­å®šã‚’ãƒãƒ¼ã‚¸
#   3. codex --config config-secure.toml ã§èµ·å‹•

# ==================== åŸºæœ¬è¨­å®š ====================
model = "gpt-5-codex"

# ğŸ†• MCP Clientæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
experimental_use_rmcp_client = true

# ğŸ” Webæ¤œç´¢æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ¢ãƒ‡ãƒ«çµ„ã¿è¾¼ã¿æ¤œç´¢ï¼‰
enable_web_search = true

# ==================== æ©Ÿèƒ½ãƒ•ãƒ©ã‚° ====================
[features]
# Webæ¤œç´¢æ©Ÿèƒ½ï¼ˆãƒ¢ãƒ‡ãƒ«çµ„ã¿è¾¼ã¿ï¼‰
web_search = true
# MCPçµ±åˆ
mcp_integration = true
# ğŸ” ã‚»ã‚­ãƒ¥ã‚¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆTLS/mTLS + æš—å·åŒ–ï¼‰
secure_mode = true

# ==================== OpenAI Provider ====================
[model_providers.openai]
base_url = "https://api.openai.com/v1"
env_key = "OPENAI_API_KEY"
name = "OpenAI (Chat Completions API)"
requires_openai_auth = true
wire_api = "chat"
enable_web_search = true
web_search_grounding = true

# ==================== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ====================
[security]
# ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
zero_trust_mode = true

# TLS/mTLSè¨­å®š
tls_enabled = true
tls_version = "1.3"  # TLS 1.3ã®ã¿è¨±å¯ï¼ˆTLS 1.2ä»¥ä¸‹ã¯æ‹’å¦ï¼‰
mtls_enabled = true  # ç›¸äº’TLSèªè¨¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸å¿…é ˆï¼‰

[security.certificates]
# è¨¼æ˜æ›¸ãƒ‘ã‚¹ï¼ˆ~/.codex/certs/ï¼‰
ca_cert = "~/.codex/certs/ca/ca-cert.pem"
client_cert = "~/.codex/certs/codex/codex-cert.pem"
client_key = "~/.codex/certs/codex/codex-key.pem"
verify_peer = true  # ãƒ”ã‚¢è¨¼æ˜æ›¸ã®æ¤œè¨¼ã‚’å¼·åˆ¶

# è¨¼æ˜æ›¸ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
[security.certificates.rotation]
enabled = true
rotation_days = 90  # 90æ—¥ã”ã¨ã«è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
warn_before_expiry_days = 14  # 14æ—¥å‰ã«è­¦å‘Š

[security.signing]
# Ed25519ç½²åéµï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç½²åç”¨ï¼‰
algorithm = "Ed25519"
signing_key = "~/.codex/keys/ed25519-signing"
signing_public_key = "~/.codex/keys/ed25519-signing.pub"

[security.encryption]
# ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æš—å·åŒ–
algorithm = "AES-256-GCM"
key_derivation = "HKDF-SHA256"
key_rotation_days = 90

[security.replay_protection]
# ãƒªãƒ—ãƒ¬ã‚¤æ”»æ’ƒå¯¾ç­–
enabled = true
nonce_store = "redis"  # "redis" or "memory" (for testing)
redis_url = "redis://localhost:6379"
timestamp_tolerance_sec = 300  # 5åˆ†ä»¥å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å—ã‘å…¥ã‚Œ

[security.rate_limiting]
# Rate Limitingï¼ˆDDoSå¯¾ç­–ï¼‰
enabled = true
max_requests_per_sec = 10.0
burst_size = 20

# ==================== Sandbox ====================
[sandbox]
default_mode = "read-only"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯èª­ã¿å–ã‚Šå°‚ç”¨

[approval]
policy = "on-request"  # å±é™ºãªæ“ä½œã¯éƒ½åº¦æ‰¿èª

# ==================== ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé€šä¿¡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ ====================
[agent_security]
encryption_enabled = true
signing_enabled = true

[agent_security.encryption]
algorithm = "AES-256-GCM"
key_derivation = "HKDF-SHA256"

[agent_security.signing]
algorithm = "Ed25519"
keys_directory = "~/.codex/keys/agents"

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆä¿¡é ¼é–¢ä¿‚ï¼ˆRBAC: Role-Based Access Controlï¼‰
[agent_security.trust]
# ç‰¹æ¨©ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨é€šä¿¡å¯èƒ½ï¼‰
privileged_agents = ["SecurityExpert"]

# CodeExpert: é™å®šçš„ãªé€šä¿¡
[agent_security.trust.CodeExpert]
can_communicate_with = ["General", "TestingExpert", "DocsExpert"]
permissions = ["read", "write"]

# SecurityExpert: ã™ã¹ã¦ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨é€šä¿¡å¯èƒ½ï¼ˆç‰¹æ¨©ï¼‰
[agent_security.trust.SecurityExpert]
can_communicate_with = ["*"]  # ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰
permissions = ["read", "write", "execute", "admin"]

# TestingExpert: åˆ¶é™ã‚ã‚Š
[agent_security.trust.TestingExpert]
can_communicate_with = ["CodeExpert", "General"]
permissions = ["read", "write"]

# DeepResearcher: å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
[agent_security.trust.DeepResearcher]
can_communicate_with = ["General"]
permissions = ["read", "network"]

# DocsExpert: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆã®ã¿
[agent_security.trust.DocsExpert]
can_communicate_with = ["General", "CodeExpert"]
permissions = ["read", "write"]

# DebugExpert: ãƒ‡ãƒãƒƒã‚°æ¨©é™
[agent_security.trust.DebugExpert]
can_communicate_with = ["General", "CodeExpert"]
permissions = ["read", "write", "execute"]

# PerformanceExpert: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
[agent_security.trust.PerformanceExpert]
can_communicate_with = ["General"]
permissions = ["read"]

# General: æ±ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
[agent_security.trust.General]
can_communicate_with = ["*"]
permissions = ["read"]

[agent_security.rate_limiting]
enabled = true
max_messages_per_sec = 5.0

# ==================== ç›£æŸ»ãƒ­ã‚° ====================
[audit]
enabled = true
log_dir = "~/.codex/audit-logs"
include_mcp_calls = true
include_agent_messages = true
include_security_events = true
include_tool_args = true
format = "json"
rotation = "daily"
retention_days = 90

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®å³æ™‚é€šçŸ¥
[audit.alerts]
enabled = true
alert_on_security_events = true
alert_email = "security@example.com"
alert_slack_webhook = "${SLACK_SECURITY_WEBHOOK}"

# é‡è¦ã‚¤ãƒ™ãƒ³ãƒˆã®é–¾å€¤
[audit.thresholds]
# mTLSèªè¨¼å¤±æ•—ãŒ5åˆ†é–“ã«10å›ä»¥ä¸Šã§ã‚¢ãƒ©ãƒ¼ãƒˆ
mtls_auth_failures_per_5min = 10
# ç½²åæ¤œè¨¼å¤±æ•—ãŒ5åˆ†é–“ã«5å›ä»¥ä¸Šã§ã‚¢ãƒ©ãƒ¼ãƒˆ
signature_failures_per_5min = 5
# Rate Limitè¶…éãŒ5åˆ†é–“ã«100å›ä»¥ä¸Šã§ã‚¢ãƒ©ãƒ¼ãƒˆ
rate_limit_exceeded_per_5min = 100

# ==================== MCP ã‚µãƒ¼ãƒãƒ¼ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ç‰ˆï¼‰ ====================
# ğŸ”’ ã™ã¹ã¦ã®MCPã‚µãƒ¼ãƒãƒ¼ã§TLS/mTLSæœ‰åŠ¹åŒ–

# Codex MCP Server - ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒãƒ¼ï¼ˆTLS/mTLSï¼‰
[mcp_servers.codex]
command = "codex"
args = ["mcp-server"]
env.RUST_LOG = "info"
env.OPENAI_API_KEY = "${OPENAI_API_KEY}"
env.GITHUB_TOKEN = "${GITHUB_TOKEN}"
env.SLACK_WEBHOOK_URL = "${SLACK_WEBHOOK_URL}"
startup_timeout_sec = 60

# ğŸ”’ TLS/mTLSè¨­å®š
transport = "https"  # ğŸ†• HTTPSã«å¤‰æ›´ï¼ˆstdioâ†’TCP+TLSï¼‰
bind_address = "127.0.0.1:8001"
tls_cert = "~/.codex/certs/mcp-servers/codex-cert.pem"
tls_key = "~/.codex/certs/mcp-servers/codex-key.pem"
require_client_cert = true  # mTLSå¿…é ˆ

# ğŸ” èªè¨¼è¨­å®š
auth_method = "mtls"  # mTLSèªè¨¼
trusted_ca = "~/.codex/certs/ca/ca-cert.pem"

# Serena - AIã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆTLS/mTLSï¼‰
[mcp_servers.serena]
command = "npx"
args = ["-y", "@modelcontextprotocol/server-everything"]
transport = "https"
bind_address = "127.0.0.1:8002"
tls_cert = "~/.codex/certs/mcp-servers/serena-cert.pem"
tls_key = "~/.codex/certs/mcp-servers/serena-key.pem"
require_client_cert = true
auth_method = "mtls"

# Gemini CLI - Google Gemini AIçµ±åˆï¼ˆTLS/mTLSï¼‰
[mcp_servers.codex-gemini-mcp]
command = "codex-gemini-mcp"
args = []
transport = "https"
bind_address = "127.0.0.1:8003"
tls_cert = "~/.codex/certs/mcp-servers/gemini-cli-cert.pem"
tls_key = "~/.codex/certs/mcp-servers/gemini-cli-key.pem"
require_client_cert = true
auth_method = "mtls"

# Filesystem - ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œï¼ˆTLS/mTLSï¼‰
[mcp_servers.filesystem]
command = "npx"
args = ["-y", "@modelcontextprotocol/server-filesystem", "C:\\Users\\downl\\Desktop\\codex"]
transport = "https"
bind_address = "127.0.0.1:8004"
tls_cert = "~/.codex/certs/mcp-servers/filesystem-cert.pem"
tls_key = "~/.codex/certs/mcp-servers/filesystem-key.pem"
require_client_cert = true
auth_method = "mtls"

# GitHub - GitHub APIï¼ˆTLS/mTLSï¼‰
[mcp_servers.github]
command = "npx"
args = ["-y", "@modelcontextprotocol/server-github"]
env.GITHUB_PERSONAL_ACCESS_TOKEN = "${GITHUB_TOKEN}"
transport = "https"
bind_address = "127.0.0.1:8005"
tls_cert = "~/.codex/certs/mcp-servers/github-cert.pem"
tls_key = "~/.codex/certs/mcp-servers/github-key.pem"
require_client_cert = true
auth_method = "mtls"

# Chrome DevTools - ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–ï¼ˆTLS/mTLSï¼‰
[mcp_servers.chrome-devtools]
command = "npx"
args = ["-y", "@modelcontextprotocol/server-chrome"]
transport = "https"
bind_address = "127.0.0.1:8006"
tls_cert = "~/.codex/certs/mcp-servers/chrome-devtools-cert.pem"
tls_key = "~/.codex/certs/mcp-servers/chrome-devtools-key.pem"
require_client_cert = true
auth_method = "mtls"

# Sequential Thinking - æ®µéšçš„æ€è€ƒï¼ˆTLS/mTLSï¼‰
[mcp_servers.sequential-thinking]
command = "npx"
args = ["-y", "@modelcontextprotocol/server-sequential-thinking"]
transport = "https"
bind_address = "127.0.0.1:8007"
tls_cert = "~/.codex/certs/mcp-servers/sequential-thinking-cert.pem"
tls_key = "~/.codex/certs/mcp-servers/sequential-thinking-key.pem"
require_client_cert = true
auth_method = "mtls"

# ... (ä»–ã®MCPã‚µãƒ¼ãƒãƒ¼ã‚‚åŒæ§˜ã«TLS/mTLSè¨­å®š)

# ==================== ã‚µãƒ–ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ ====================
[subagents]
enabled = true
max_parallel = 4
token_budget = 40000
inherit_model = true
use_codex_mcp = true

# ğŸ” ã‚»ã‚­ãƒ¥ã‚¢é€šä¿¡æœ‰åŠ¹åŒ–
secure_channel = true
encryption_enabled = true
signing_enabled = true

# ==================== Deep Research ====================
[deep_research]
enabled = true
default_backend = "gemini"  # Gemini Search Grounding
fallback_backends = ["duckduckgo", "google", "bing"]
max_sources = 10
citation_style = "academic"

# ==================== ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚° ====================
[monitoring]
enabled = true
prometheus_endpoint = "http://localhost:9090"
grafana_dashboard_url = "http://localhost:3000/d/codex-security"

[monitoring.metrics]
# åé›†ã™ã‚‹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
collect_tls_metrics = true
collect_auth_metrics = true
collect_rate_limit_metrics = true
collect_agent_metrics = true

[monitoring.export]
# ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
format = "prometheus"
export_interval_sec = 30

# ==================== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ====================
[backup]
enabled = true
backup_dir = "~/.codex/backups"
backup_interval_hours = 24
retention_days = 30

# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¯¾è±¡
[backup.targets]
include_certs = true
include_keys = true
include_audit_logs = true
include_config = true

# ==================== ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ ====================
[compliance]
# ISO 27001æº–æ‹ ãƒ¢ãƒ¼ãƒ‰
iso27001_mode = true

# GDPRæº–æ‹ 
gdpr_mode = true
data_retention_days = 90

# SOC 2 Type II
soc2_mode = true

[compliance.reporting]
# ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
enabled = true
report_dir = "~/.codex/compliance-reports"
report_frequency = "monthly"

# ==================== é–‹ç™ºè€…ãƒ¢ãƒ¼ãƒ‰ ====================
[developer]
# é–‹ç™ºæ™‚ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç·©å’Œï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ï¼‰
development_mode = false

[developer.overrides]
# é–‹ç™ºæ™‚ã®ã¿æœ‰åŠ¹ï¼ˆæœ¬ç•ªã§ã¯å¿…ãš falseï¼‰
disable_tls = false
disable_mtls = false
disable_encryption = false
disable_signing = false
disable_rate_limiting = false

# ==================== END OF CONFIG ====================

# ğŸ“š å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
#   - ã‚»ã‚­ãƒ¥ã‚¢é€šä¿¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸: _docs/2025-10-28_ã‚»ã‚­ãƒ¥ã‚¢é€šä¿¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆæ›¸.md
#   - è¨¼æ˜æ›¸ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ: zapabob/scripts/generate-mcp-certs.ps1
#   - ç›£æŸ»ãƒ­ã‚°ä»•æ§˜: codex-rs/core/src/audit_log/
#
# âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„äº‹é …:
#   - æœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãšè¨¼æ˜æ›¸ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
#   - ç§˜å¯†éµï¼ˆ*-key.pemï¼‰ã¯çµ¶å¯¾ã«Gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„
#   - CAç§˜å¯†éµï¼ˆca-key.pemï¼‰ã¯ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¨å¥¨
#   - è¨¼æ˜æ›¸ã¯90æ—¥ã”ã¨ã«ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„

